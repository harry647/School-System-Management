# Borrowing Templates System

## Overview

The Borrowing Templates System allows librarians to generate printable Excel and PDF templates for book borrowing distribution. This system creates structured templates with student information and blank columns for book numbers, enabling efficient bulk book distribution.

## Features

### Template Types

1. **Individual Class Templates**
   - Creates separate templates for each class level
   - Groups all students in a class together
   - Example: Form 4 All Streams, Form 10 All Streams

2. **Individual Stream per Subject Templates**
   - Creates templates for specific class-stream-subject combinations
   - Allows fine-grained distribution planning
   - Example: Form 4 Red Mathematics, Form 4 Blue English

3. **All Classes Combined Template**
   - Single comprehensive template with all students
   - Useful for overview and planning

### Output Formats

- **Excel (.xlsx)**: Editable spreadsheet with formatting
- **PDF (.pdf)**: Print-ready document
- **Both**: Generate both formats simultaneously

### Template Content

Each template includes:

#### Header Information
- School Name: "School Management System"
- Class/Form details
- Stream details
- Subject details
- Generation date and librarian name

#### Student Information Table
- Serial Number (#)
- Student Name
- Admission Number
- **Book Number** (blank for user input)
- Signature column (for student acknowledgment)

#### Footer Instructions
- How to fill book numbers
- Student signature requirements
- Return instructions

## User Interface

### Access
Navigate to **Library Management** ‚Üí **üì¶ Distribution** ‚Üí **Borrowing Templates** tab

### Template Generation Process

1. **Select Template Type**
   - Individual Class Templates
   - Individual Stream per Subject Templates
   - All Classes Combined Template

2. **Configure Filters** (for Stream per Subject templates)
   - Class: Filter by specific class or "All Classes"
   - Stream: Filter by specific stream or "All Streams"
   - Subject: Filter by specific subject or "All Subjects"

3. **Choose Output Format**
   - Excel (.xlsx)
   - PDF (.pdf)
   - Both

4. **Generate Templates**
   - Click "üìÑ Generate Templates"
   - Monitor progress bar
   - View success message with file locations

### Preview Feature
- Click "üëÅÔ∏è Preview" to see template structure before generation
- Shows number of templates and total students
- Displays sample student data

## Technical Implementation

### Data Sources

Templates pull data from:
- **Student Service**: Student names and admission numbers
- **Class Management Service**: Class-stream combinations
- **Current User**: Librarian name for templates

### File Generation

#### Excel Templates
- Uses pandas for data manipulation
- openpyxl for Excel formatting
- Auto-sized columns
- Styled headers with blue background
- Temporary file storage

#### PDF Templates
- Uses FPDF library for PDF generation
- Structured table layout
- Header and footer sections
- Print-optimized formatting

### File Naming Convention

Templates are saved as temporary files with descriptive names:
- Excel: `*_borrowing_template.xlsx`
- PDF: `*_borrowing_template.pdf`

## Excel Template Structure

| Column | Description | Example |
|--------|-------------|---------|
| School_Name | School identifier | School Management System |
| Class_Form | Class level | 4 |
| Stream | Stream name | Red |
| Subject | Subject name | Mathematics |
| Student_Name | Full student name | John Doe |
| Admission_Number | Student ID | 2024001 |
| Book_Number | **BLANK** - for user input | (empty) |
| Date_Borrowed | **BLANK** - for user input | (empty) |
| Librarian_Name | Auto-filled | admin |
| Generated_Date | Auto-filled | 2024-01-15 |

## PDF Template Structure

### Header Section
```
SCHOOL MANAGEMENT SYSTEM
BOOK BORROWING TEMPLATE

Class/Form: 4
Stream: Red
Subject: Mathematics
Generated by: admin
Date: 2024-01-15 14:30:00
```

### Table Structure
| # | Student Name | Admission No. | Book Number | Signature |
|---|-------------|---------------|-------------|-----------|
| 1 | John Doe | 2024001 | ___________ | ___________ |
| 2 | Jane Smith | 2024002 | ___________ | ___________ |

### Footer Instructions
```
Instructions:
1. Fill in the Book Number column with the assigned book numbers.
2. Students should sign in the Signature column when receiving books.
3. Return this form to the librarian after distribution.
```

## Usage Workflow

### 1. Planning Distribution
- Choose appropriate template type based on distribution scope
- Use preview to verify student counts and groupings

### 2. Generating Templates
- Select filters for targeted distribution
- Choose output format(s)
- Generate and download templates

### 3. Filling Templates
- Print or open templates in Excel
- Fill book numbers for each student
- Have students sign acknowledgment

### 4. Distribution Execution
- Use filled templates as checklists
- Track book assignments
- Collect signed acknowledgments

## Integration Points

### Database Dependencies
- **students** table: admission_number, name, stream
- **books** table: subject, class fields
- **borrowed_books_student** table: for validation

### Service Dependencies
- **StudentService**: get_all_students(), get_students_by_class_level()
- **ClassManagementService**: get_class_stream_combinations()
- **BookService**: (indirectly for book validation)

### UI Integration
- Integrated into existing Distribution window
- Uses consistent theming and styling
- Progress indicators for long operations

## Error Handling

### Common Issues

#### No Students Found
- Check class/stream filters
- Verify student data exists in database
- Run database migrations if needed

#### Template Generation Fails
- Check file system permissions
- Verify required libraries installed
- Check available disk space

#### Excel/PDF Libraries Missing
- Install required packages:
  ```bash
  pip install pandas openpyxl fpdf
  ```

### Recovery Procedures

1. **Template Preview Shows No Data**
   - Verify students exist for selected criteria
   - Check database connectivity
   - Try different filter combinations

2. **File Generation Fails**
   - Check temporary directory permissions
   - Clear temporary files
   - Restart application

## Performance Considerations

### Large Student Populations
- Templates generated in background with progress indicators
- Batch processing for multiple templates
- Memory-efficient data handling

### File Size Management
- Temporary files cleaned up automatically
- Reasonable column widths to prevent oversized files
- Compressed PDF generation

## Future Enhancements

### Planned Features
- **Email Distribution**: Send templates via email
- **Cloud Storage**: Save templates to cloud services
- **Barcode Integration**: Add barcode printing
- **Bulk Printing**: Print multiple templates at once
- **Template Customization**: Custom headers and layouts
- **Historical Tracking**: Save generated templates

### API Integration
```python
# Future API endpoints
POST /api/templates/generate
GET /api/templates/{id}/download
POST /api/templates/{id}/email
```

## Security Considerations

### Data Privacy
- Templates contain student names and IDs
- No sensitive personal information included
- Temporary file cleanup prevents data leakage

### Access Control
- Librarian-only access to template generation
- User attribution on all templates
- Audit logging of template generation

## Troubleshooting

### Debug Mode
Enable debug logging to track template generation:
```python
import logging
logging.getLogger('school_system').setLevel(logging.DEBUG)
```

### Log Analysis
Check application logs for:
- Template generation errors
- Database query failures
- File system issues

### Manual Template Creation
If automated generation fails, templates can be created manually using the data structure documented above.

## Support

For technical support or feature requests related to the Borrowing Templates system, refer to the main application documentation or contact the development team.